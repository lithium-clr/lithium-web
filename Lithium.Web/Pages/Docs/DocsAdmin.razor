@page "/docs/admin"
@using System.IO
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "CanManageDocs")]
@inject IWebHostEnvironment Env
@inject NavigationManager NavigationManager
@inject IJSRuntime JsRuntime
@rendermode InteractiveServer

<div class="w-full px-4 sm:px-8 lg:px-16 xl:px-24 py-16 text-white">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-white">Documentation Admin</h1>
        <button @onclick="CreateNewDoc"
                class="inline-flex items-center gap-2 bg-lithium-100/80 hover:bg-lithium-100 text-white font-semibold py-2 px-4 border border-lithium-200 rounded-lg shadow-sm transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                      d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                      clip-rule="evenodd"/>
            </svg>
            Create New
        </button>
    </div>

    @if (_docs.Any())
    {
        <div class="bg-lithium-0/50 border border-lithium-100 rounded-lg shadow-lg overflow-hidden">
            <table class="min-w-full divide-y divide-lithium-100">
                <thead class="bg-lithium-50/50">
                <tr>
                    <th scope="col"
                        class="px-6 py-3 text-left text-xs font-medium text-lithium-300 uppercase tracking-wider">
                        Title
                    </th>
                    <th scope="col"
                        class="px-6 py-3 text-left text-xs font-medium text-lithium-300 uppercase tracking-wider">
                        Category
                    </th>
                    <th scope="col"
                        class="px-6 py-3 text-left text-xs font-medium text-lithium-300 uppercase tracking-wider">
                        Slug
                    </th>
                    <th scope="col" class="relative px-6 py-3">
                        <span class="sr-only">Actions</span>
                    </th>
                </tr>
                </thead>
                <tbody class="bg-lithium-0/30 divide-y divide-lithium-100">
                @foreach (var doc in _docs)
                {
                    <tr class="hover:bg-lithium-50/20 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">
                            @doc.Title
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-lithium-400">
                            @doc.Category
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-lithium-400 font-mono">
                            @doc.Slug
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                            <button @onclick="() => EditDoc(doc.Slug)"
                                    class="inline-flex items-center gap-1 text-lithium-300 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                     fill="currentColor">
                                    <path
                                        d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"/>
                                    <path fill-rule="evenodd"
                                          d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                                          clip-rule="evenodd"/>
                                </svg>
                                Edit
                            </button>
                            <button @onclick="() => ConfirmDelete(doc.Slug)"
                                    class="inline-flex items-center gap-1 text-red-400 hover:text-red-300 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                     fill="currentColor">
                                    <path fill-rule="evenodd"
                                          d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z"
                                          clip-rule="evenodd"/>
                                </svg>
                                Delete
                            </button>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="text-center py-16 bg-lithium-0/20 border border-lithium-100 rounded-lg">
            <h3 class="text-xl font-medium text-white">No Documents Found</h3>
            <p class="mt-2 text-sm text-lithium-400">Click the "Create New" button to add your first document.</p>
        </div>
    }
</div>

@code {

    private class DocInfo
    {
        public string Slug { get; init; } = null!;
        public string Title { get; init; } = null!;
        public string Category { get; init; } = null!;
        public string FilePath { get; init; } = null!;
    }

    private string _docsPath = null!;
    private List<DocInfo> _docs = [];

    protected override void OnInitialized()
    {
        _docsPath = Path.Combine(Env.WebRootPath, "docs");
        LoadDocs();
    }

    private void LoadDocs()
    {
        _docs.Clear();

        var files = Directory.GetFiles(_docsPath, "*.md", SearchOption.AllDirectories);

        foreach (var file in files)
        {
            var markdown = File.ReadAllText(file);
            var slug = Path.GetFileNameWithoutExtension(file);
            var meta = ParseYamlFrontMatter(markdown);

            _docs.Add(new DocInfo
            {
                Slug = slug,
                Title = meta.GetValueOrDefault("title", slug),
                Category = meta.GetValueOrDefault("category", "Uncategorized"),
                FilePath = file
            });
        }

        _docs = _docs.OrderBy(d => d.Category).ThenBy(d => d.Title).ToList();
    }

    private static Dictionary<string, string> ParseYamlFrontMatter(string markdown)
    {
        var dict = new Dictionary<string, string>();

        var match = Regex.Match(markdown, @"^---\s*(.+?)\s*---", RegexOptions.Singleline);
        if (!match.Success) return dict;

        var yaml = match.Groups[1].Value;

        foreach (var line in yaml.Split('\n'))
        {
            var parts = line.Split(':', 2);

            if (parts.Length is 2)
                dict[parts[0].Trim()] = parts[1].Trim().Trim('"');
        }

        return dict;
    }

    private void CreateNewDoc()
    {
        NavigationManager.NavigateTo("/docs/edit");
    }

    private void EditDoc(string slug)
    {
        NavigationManager.NavigateTo($"/docs/edit/{slug}");
    }

    private async Task ConfirmDelete(string slug)
    {
        var docTitle = _docs.FirstOrDefault(d => d.Slug == slug)?.Title ?? slug;
        var confirmed = await JsRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete the document '{docTitle}'?");

        if (confirmed)
            DeleteDoc(slug);
    }

    private void DeleteDoc(string slug)
    {
        var doc = _docs.FirstOrDefault(d => d.Slug == slug);
        if (doc is null) return;
        
        File.Delete(doc.FilePath);
        LoadDocs();
        StateHasChanged();
    }

}
