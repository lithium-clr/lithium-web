@page "/docs"
@page "/docs/{Slug}"
@using System.Text.RegularExpressions
@using Markdig
@using Markdig.Syntax
@using LucideBlazor
@using PSC.Blazor.Components.MarkdownEditor
@inject NavigationManager NavigationManager
@inject IWebHostEnvironment Env
@inject IJSRuntime JsRuntime
@layout EmptyLayout
@rendermode InteractiveServer
@implements IDisposable

<SearchModal @bind-IsOpen="_isSearchModalOpen" AllDocs="_docs"/>

<HeadContent>
    <link href="prism.css" rel="stylesheet"/>
</HeadContent>
<body>
<script src="prism.js"></script>
</body>

<div class="flex h-screen bg-lithium-0 text-lithium-400 font-sans selection:bg-lithium-100 selection:text-white">
    <!-- Mobile Sidebar Backdrop -->
    @if (_isNavOpen)
    {
        <div class="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm lg:hidden" @onclick="CloseSidebars"></div>
    }

    <!-- Left Sidebar (Navigation) -->
    @if (!_isEditMode)
    {
        <div class="flex justify-end w-96 py-8 bg-lithium-0 border-r border-lithium-100/50">
            <aside
                class="@(_isNavOpen ? "translate-x-0" : "-translate-x-full") fixed inset-y-0 left-0 z-50 w-72 transition-transform duration-300 ease-in-out lg:static lg:translate-x-0 flex flex-col shrink-0">

                <!-- Logo -->
                <div class="flex items-center h-16 px-4 shrink-0">
                    <div class="flex items-center gap-1">
                        <a href="/"
                           class="flex items-center text-lg tracking-tight text-lithium-800! hover:text-white! transition-colors">
                            <span class="font-bold">Lithium</span>
                        </a>
                        <span>/</span>
                        <span>Docs</span>
                    </div>
                </div>

                <!-- Search & Navigation -->
                <div class="flex-1 overflow-y-auto px-4 pb-4 space-y-8 scrollbar-hide">
                    <!-- Search -->
                    <button @onclick="OpenSearchModal"
                            class="w-full flex items-center justify-between px-3 py-2.5 text-sm text-lithium-400 bg-lithium-50/50 border border-lithium-100/50 rounded-lg hover:border-lithium-100 hover:bg-lithium-50 hover:text-white! transition-all group shadow-sm">
                        <div class="flex items-center gap-2.5">
                            <SearchIcon Size="15" class="group-hover:text-white transition-colors"/>
                            <span>Search...</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <kbd
                                class="hidden sm:inline-flex items-center h-5 px-1.5 text-[10px] font-medium text-lithium-500 bg-lithium-100/50 rounded border border-lithium-200/20 font-mono">CTRL</kbd>
                            <kbd
                                class="hidden sm:inline-flex items-center h-5 px-1.5 text-[10px] font-medium text-lithium-500 bg-lithium-100/50 rounded border border-lithium-200/20 font-mono">K</kbd>
                        </div>
                    </button>

                    <!-- Navigation Links -->
                    <nav class="space-y-8">
                        @foreach (var group in _docs.GroupBy(x => x.Category, StringComparer.InvariantCultureIgnoreCase))
                        {
                            <div>
                                <h3 class="px-2 mb-3 text-xs font-bold text-lithium-500 uppercase tracking-widest">
                                    @group.Key
                                </h3>
                                <div class="space-y-0.5">
                                    @foreach (var doc in group)
                                    {
                                        <NavLink href="@("/docs/" + doc.Slug)" @onclick="CloseSidebars"
                                                 class="group flex items-center gap-3 px-3 py-2 bg-lithium-0 hover:bg-lithium-100/60 aria-[current=page]:bg-lithium-100 text-sm rounded-md">
                                            <span class="transition-opacity">@doc.Icon</span>
                                            <span
                                                class="text-lithium-400 group-hover:text-white! group-aria-[current=page]:text-white! transition-all">@doc.Title</span>
                                        </NavLink>
                                    }
                                </div>
                            </div>
                        }
                    </nav>
                </div>
            </aside>
        </div>
    }

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">

        <!-- Mobile Header -->
        <header
            class="flex items-center justify-between h-16 px-4 border-b border-lithium-100/50 bg-lithium-0/80 backdrop-blur-md lg:hidden shrink-0 z-30 sticky top-0">
            <button @onclick="ToggleNav" class="p-2 -ml-2 text-lithium-400 hover:text-white! rounded-md">
                <MenuIcon Size="20"/>
            </button>
            <span class="font-semibold text-white! truncate">@(_docs.FirstOrDefault(d => d.Slug == Slug)?.Title)</span>
            <button @onclick="ToggleToc" class="p-2 -mr-2 text-lithium-400 hover:text-white! rounded-md">
                <ListIcon Size="20"/>
            </button>
        </header>

        <!-- Scrollable Content -->
        <main class="flex-1 overflow-y-auto scroll-smooth" id="docs-content">
            <div
                class="@(_isEditMode ? "max-w-full px-4 py-4 h-full" : "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4 pb-8")">

                @if (_isEditMode)
                {
                    <EditForm Model="@_doc" OnValidSubmit="SaveChanges" id="doc-edit-form"
                              class="flex flex-col h-full gap-4">
                        <DataAnnotationsValidator/>

                        <!-- Editor Toolbar -->
                        <div
                            class="flex items-center justify-between px-4 py-3 bg-lithium-50/50 border border-lithium-100/50 rounded-xl backdrop-blur-sm shrink-0">
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2">
                                    <span
                                        class="text-xs font-bold text-lithium-500 uppercase tracking-wider">Editing:</span>
                                    <span class="text-sm font-medium text-white!">@_doc.Title</span>
                                </div>
                                <div class="h-4 w-px bg-lithium-200"></div>
                                <button type="button" @onclick="() => _isMetadataModalOpen = true"
                                        class="flex items-center gap-2 px-3 py-2 text-xs font-medium text-lithium-600 hover:text-white! bg-lithium-50 border border-lithium-100 hover:border-lithium-200 rounded-md transition-colors">
                                    <SettingsIcon Size="12"/>
                                    Metadata
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                <button type="button" @onclick="CancelEdit"
                                        class="px-3 py-2 text-xs font-medium text-lithium-600 hover:text-white! transition-colors">
                                    Cancel
                                </button>
                                <button type="submit"
                                        class="inline-flex items-center gap-1.5 px-3 py-2 text-xs font-medium text-lithium-900! bg-lithium-100! hover:bg-lithium-200! rounded-md transition-colors">
                                    <SaveIcon Size="12"/>
                                    Save Changes
                                </button>
                            </div>
                        </div>

                        <!-- Metadata Modal -->
                        @if (_isMetadataModalOpen)
                        {
                            <div
                                class="fixed inset-0 z-60 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4"
                                @onclick="() => _isMetadataModalOpen = false">
                                <div
                                    class="w-full max-w-lg bg-lithium-0 border border-lithium-100/50 rounded-xl shadow-2xl overflow-hidden"
                                    @onclick:stopPropagation>
                                    <div
                                        class="px-6 py-4 border-b border-lithium-100/50 flex items-center justify-between">
                                        <h3 class="font-bold text-white">Page Metadata</h3>
                                        <button @onclick="() => _isMetadataModalOpen = false"
                                                class="text-lithium-400 hover:text-white!">
                                            <XIcon Size="16"/>
                                        </button>
                                    </div>
                                    <div class="p-6 space-y-4">
                                        <div class="space-y-1.5">
                                            <label class="text-xs font-bold text-lithium-500 uppercase tracking-wider">Title</label>
                                            <InputText @bind-Value="_doc.Title"
                                                       class="w-full bg-lithium-50/50 border border-lithium-100/50 rounded-lg px-3 py-2 text-sm text-white! focus:border-lithium-300 outline-none transition-all placeholder-lithium-600"
                                                       placeholder="Page Title"/>
                                        </div>
                                        <div class="space-y-1.5">
                                            <label class="text-xs font-bold text-lithium-500 uppercase tracking-wider">Slug</label>
                                            <InputText @bind-Value="_doc.Slug"
                                                       class="w-full bg-lithium-50/50 border border-lithium-100/50 rounded-lg px-3 py-2 text-sm text-white! focus:border-lithium-300 outline-none transition-all placeholder-lithium-600"
                                                       placeholder="page-slug"/>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="space-y-1.5">
                                                <label
                                                    class="text-xs font-bold text-lithium-500 uppercase tracking-wider">Icon</label>
                                                <InputText @bind-Value="_doc.Icon"
                                                           class="w-full bg-lithium-50/50 border border-lithium-100/50 rounded-lg px-3 py-2 text-sm text-white! focus:border-lithium-300 outline-none transition-all placeholder-lithium-600"
                                                           placeholder="Icon"/>
                                            </div>
                                            <div class="space-y-1.5">
                                                <label
                                                    class="text-xs font-bold text-lithium-500 uppercase tracking-wider">Category</label>
                                                <InputText @bind-Value="_doc.Category"
                                                           class="w-full bg-lithium-50/50 border border-lithium-100/50 rounded-lg px-3 py-2 text-sm text-white! focus:border-lithium-300 outline-none transition-all placeholder-lithium-600"
                                                           placeholder="Category"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        class="px-6 py-4 bg-lithium-50/30 border-t border-lithium-100/50 flex justify-end">
                                        <button type="button" @onclick="() => _isMetadataModalOpen = false"
                                                class="px-4 py-2 text-xs font-bold text-lithium-900! hover:text-white! hover:bg-lithium-100! border border-lithium-100 hover:border-lithium-200 rounded-md transition-colors">
                                            Done
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- Split View Editor -->
                        <div class="flex-1 grid grid-cols-2 gap-4 min-h-0">
                            <!-- Markdown Input -->
                            <div
                                class="flex flex-col h-full bg-lithium-0 border border-lithium-100/50 rounded-xl overflow-hidden shadow-sm">
                                <div
                                    class="bg-lithium-50/50 px-4 py-2 border-b border-lithium-100/50 text-xs font-bold text-lithium-500 uppercase tracking-wider flex justify-between items-center">
                                    <span>Markdown</span>
                                    <span class="text-[10px] text-lithium-600 font-mono">MARKDOWN</span>
                                </div>
                                <div class="flex-1 overflow-hidden editor-wrapper">
                                    <MarkdownEditor LineNumbers="true" Toolbar="null" MinHeight="100%" MaxHeight="100%"
                                                    Value="@_doc.Content" ValueChanged="OnMarkdownValueChanged"/>
                                </div>
                            </div>

                            <!-- Live Preview -->
                            <div
                                class="flex flex-col h-full bg-lithium-0 border border-lithium-100/50 rounded-xl overflow-hidden shadow-sm">
                                <div
                                    class="bg-lithium-50/50 px-4 py-2 border-b border-lithium-100/50 text-xs font-bold text-lithium-500 uppercase tracking-wider flex justify-between items-center">
                                    <span>Preview</span>
                                    <span class="text-[10px] text-lithium-600 font-mono">HTML</span>
                                </div>
                                <div class="flex-1 overflow-y-auto p-8 prose prose-invert max-w-none">
                                    @((MarkupString)_htmlContent)
                                </div>
                            </div>
                        </div>
                    </EditForm>
                }
                else
                {
                    <!-- Article Content -->
                    <article class="flex-1 min-w-0">
                        <!-- Breadcrumbs & Edit Actions -->
                        <div
                            class="sticky top-0 bg-lithium-0 flex items-center justify-between py-8 border-b border-lithium-100/50">
                            <nav class="flex" aria-label="Breadcrumb">
                                <ol class="flex items-center space-x-2 text-sm text-lithium-500">
                                    <li><a href="/docs"
                                           class="text-lithium-500! hover:text-white! transition-colors">Docs</a>
                                    </li>
                                    <li>
                                        <ChevronRightIcon Size="14" class="text-lithium-600"/>
                                    </li>
                                    <li class="text-white! font-medium">@(_docs.FirstOrDefault(d => d.Slug == Slug)?.Title)</li>
                                </ol>
                            </nav>

                            <AuthorizeView Policy="CanManageDocs">
                                <Authorized>
                                    <button @onclick="ToggleEditMode"
                                            class="inline-flex items-center gap-1.5 px-3 py-2 text-xs font-medium text-white bg-lithium-50/50 border border-lithium-100/50 rounded-md hover:text-white! hover:border-lithium-100 transition-all">
                                        <PencilIcon Size="12"/>
                                        Edit Page
                                    </button>
                                </Authorized>
                            </AuthorizeView>
                        </div>

                        <div class="prose">
                            @((MarkupString)_htmlContent)
                        </div>

                        <!-- Page Footer -->
                        <div
                            class="mt-20 pt-8 border-t border-lithium-100/50 flex flex-col sm:flex-row justify-between items-center gap-4 text-sm text-lithium-500">
                            <div class="flex items-center gap-2">
                                <span>Last updated on @DateTime.Now.ToString("MMMM dd, yyyy")</span>
                            </div>
                            <div class="flex gap-6">
                                <a href="#" class="text-lithium-900! hover:text-white! transition-colors">Privacy
                                    Policy</a>
                                <a href="#" class="text-lithium-900! hover:text-white! transition-colors">Terms of
                                    Service</a>
                            </div>
                        </div>
                    </article>
                }
            </div>
        </main>
    </div>

    <!-- Right Sidebar (Table of Contents) -->
    <div class="flex justify-start w-96 py-8 bg-lithium-0">
        <aside class="hidden xl:block w-72 ml-4 shrink-0">
            <div class="fixed">
                <h4 class="py-6 text-xs font-bold text-white! uppercase tracking-wider">On this
                    page</h4>
                <ul class="space-y-1">
                    @foreach (var heading in _headings)
                    {
                        var slugUri = $"/docs/{Slug}/#{heading.Slug}";

                        <li>
                            <a href="@slugUri"
                               class="toc-link block py-1 text-sm text-lithium-500! hover:text-white! transition-colors border-l-2 border-transparent pl-4 -ml-px truncate"
                               data-target="@heading.Slug"
                               style="padding-left: @(heading.Level)rem">
                                @heading.Text
                            </a>
                        </li>
                    }
                </ul>

                <!-- Quick Links -->
                <div class="pt-6 mt-6 border-t border-lithium-100/50">
                    <h4 class="mb-4 text-xs font-bold text-white! uppercase tracking-wider">
                        Community</h4>
                    <ul class="space-y-3 text-sm">
                        <li>
                            <a href="#"
                               class="flex items-center gap-2 text-lithium-900! hover:text-white! transition-colors group">
                                <div
                                    class="p-1 rounded-md bg-lithium-50/50 group-hover:bg-lithium-50 transition-colors">
                                    <GithubIcon Size="14"/>
                                </div>
                                <span>Edit on GitHub</span>
                            </a>
                        </li>
                        <li>
                            <a href="#"
                               class="flex items-center gap-2 text-lithium-900! hover:text-white! transition-colors group">
                                <div
                                    class="p-1 rounded-md bg-lithium-50/50 group-hover:bg-lithium-50 transition-colors">
                                    <MessageCircleIcon Size="14"/>
                                </div>
                                <span>Join Discord</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </aside>
    </div>

    <!-- Mobile TOC Drawer -->
    @if (_isTocOpen)
    {
        <div class="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm xl:hidden" @onclick="CloseSidebars"></div>
        <div
            class="fixed inset-y-0 right-0 z-50 w-72 bg-lithium-0 border-l border-lithium-100/50 shadow-2xl transform transition-transform duration-300 ease-in-out xl:hidden overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="font-bold text-white!">On this page</h3>
                    <button @onclick="CloseSidebars" class="text-lithium-400 hover:text-white!">
                        <XIcon Size="20"/>
                    </button>
                </div>
                <ul class="space-y-3">
                    @foreach (var heading in _headings)
                    {
                        var slugUri = $"/docs/{Slug}/#{heading.Slug}";

                        <li>
                            <a href="@slugUri" @onclick="CloseSidebars"
                               class="block text-sm text-lithium-500! hover:text-white! transition-colors"
                               style="padding-left: @((heading.Level - 1) * 1)rem">
                                @heading.Text
                            </a>
                        </li>
                    }
                </ul>
            </div>
        </div>
    }
</div>

<style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: #27272a;
        border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #3f3f46;
    }

    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .EasyMDEContainer {
        height: 100%;
        border: none !important;

        .CodeMirror {
            background: transparent !important;
            height: 100%;
            border: none !important;
            color: white !important;
            font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            padding: 0.5rem 0;
        }

        .CodeMirror-size {
        }

        .CodeMirror-gutters {
            background: transparent !important;
            border-right: 1px solid var(--color-lithium-100) !important;
            color: var(--color-lithium-500) !important;
            display: none;
        }

        .CodeMirror-linenumber {
            color: var(--color-lithium-500) !important;
            display: none !important;
        }

        .CodeMirror-cursor {
            border-left: 2px solid white !important;
        }

        .CodeMirror-selected {
            background: var(--color-lithium-100) !important;
        }

        .editor-toolbar {
            @* border-left: 1px solid var(--color-lithium-100) !important; *@
            @* border-right: 1px solid var(--color-lithium-100) !important; *@
            @* border-top: 1px solid var(--color-lithium-100) !important; *@

            border: none;
            border-bottom: 1px solid var(--color-lithium-50) !important;

            i.separator {
                display: none;
            }

            button {
                &:hover {
                    background: var(--color-lithium-100) !important;
                    border: solid 1px var(--color-lithium-200);

                    i {
                        color: white !important;
                    }
                }

                i {
                    color: var(--color-lithium-500) !important;
                }
            }
        }

        .cm-header {
            color: white !important;
            font-weight: bold;
            font-size: 32px !important;
            font-family: Satoshi;
        }

        .cm-quote {
            color: var(--color-lithium-400) !important;
            font-style: italic;
        }

        .cm-link {
            color: var(--color-lithium-300) !important;
        }

        .cm-url {
            color: var(--color-lithium-400) !important;
        }

        /* Editor Customization */

        .editor-wrapper .cm-editor {
            height: 100%;
            background-color: transparent;
        }

        .editor-wrapper .cm-scroller {
            font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .editor-wrapper .cm-gutters {
            background-color: transparent;
            border-right: 1px solid #27272a;
        }
    }
</style>

<script>
    window.lithiumDocs = {
        dotNetHelper: null,
        init: function (dotNetHelper) {
            this.dotNetHelper = dotNetHelper;
            document.addEventListener('keydown', this.handleKeyDown.bind(this));
        },
        handleKeyDown: function (e) {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                this.dotNetHelper.invokeMethodAsync('OpenSearchModal');
            }
        },
        dispose: function () {
            document.removeEventListener('keydown', this.handleKeyDown.bind(this));
        },
        scrollHandler: null,
        initScrollSpy: function () {
            const scrollContainer = document.getElementById('docs-content');
            if (!scrollContainer) return;

            const headings = Array.from(document.querySelectorAll('.prose h1, .prose h2, .prose h3'));
            const tocLinks = document.querySelectorAll('.toc-link');

            if (headings.length === 0) return;

            const onScroll = () => {
                let activeId = null;

                // Find the first heading that is in the viewport
                for (let i = 0; i < headings.length; i++) {
                    const heading = headings[i];
                    const rect = heading.getBoundingClientRect();

                    // If heading is near the top (with some offset)
                    if (rect.top >= 0 && rect.top <= 200) {
                        activeId = heading.id;
                        break;
                    }

                    // If we scrolled past this heading, it might be the active one
                    if (rect.top < 0) {
                        activeId = heading.id;
                    }
                }

                // If we are at the very top, activate the first one
                if (!activeId && headings.length > 0 && scrollContainer.scrollTop < 50) {
                    activeId = headings[0].id;
                }

                tocLinks.forEach(link => {
                    const targetId = link.getAttribute('data-target');
                    if (targetId === activeId) {
                        link.classList.remove('border-transparent', 'text-lithium-500');
                        link.classList.add('border-lithium-100', 'text-white!', 'font-medium');
                    } else {
                        link.classList.add('border-transparent', 'text-lithium-500');
                        link.classList.remove('border-lithium-100', 'text-white!', 'font-medium');
                    }
                });
            };

            if (this.scrollHandler) {
                scrollContainer.removeEventListener('scroll', this.scrollHandler);
            }
            this.scrollHandler = onScroll;
            scrollContainer.addEventListener('scroll', onScroll);

            // Initial check
            onScroll();
        }
    };
</script>

@code {

    private class Heading
    {
        public string Text { get; init; } = null!;
        public string Slug { get; init; } = null!;
        public int Level { get; init; }
    }

    private readonly List<DocModel> _docs = [];
    private string _htmlContent = null!;
    private List<Heading> _headings = [];
    private string? _currentSlug;
    private bool _isNavOpen;
    private bool _isTocOpen;
    private bool _isSearchModalOpen;
    private bool _isEditMode;
    private bool _isMetadataModalOpen;
    private readonly DocModel _doc = new();
    private DocModel _originalDoc = new();
    private string _docsPath = null!;
    private string _originalSlug = null!;

    [Parameter] public string? Slug { get; set; }

    [JSInvokable]
    public void OpenSearchModal()
    {
        _isSearchModalOpen = true;
        StateHasChanged();
    }

    private void ToggleNav()
    {
        _isNavOpen = !_isNavOpen;
        if (_isNavOpen) _isTocOpen = false;
    }

    private void ToggleToc()
    {
        _isTocOpen = !_isTocOpen;
        if (_isTocOpen) _isNavOpen = false;
    }

    private void CloseSidebars()
    {
        _isNavOpen = false;
        _isTocOpen = false;
    }

    protected override void OnInitialized()
    {
        _docsPath = Path.Combine(Env.WebRootPath, "docs");

        if (!Directory.Exists(_docsPath))
        {
            Directory.CreateDirectory(_docsPath);
        }

        var files = Directory.GetFiles(_docsPath, "*.md", SearchOption.AllDirectories);

        foreach (var file in files)
        {
            var markdown = File.ReadAllText(file);
            var meta = ParseYamlFrontMatter(markdown);
            var slug = Path.GetFileNameWithoutExtension(file);

            _docs.Add(new DocModel
            {
                Slug = slug,
                Title = meta.GetValueOrDefault("title", slug),
                Icon = meta.GetValueOrDefault("icon", "ðŸ“„"),
                Category = meta.GetValueOrDefault("category", "General"),
                Content = Regex.Replace(markdown, @"^---\s*(.+?)\s*---\s*", "", RegexOptions.Singleline).Trim()
            });
        }
    }

    protected override Task OnParametersSetAsync()
    {
        if (Slug == _currentSlug)
            return Task.CompletedTask;

        _currentSlug = Slug;

        if (string.IsNullOrEmpty(Slug))
        {
            var firstDoc = _docs.FirstOrDefault();

            if (firstDoc is not null)
                NavigationManager.NavigateTo($"/docs/{firstDoc.Slug}");

            return Task.CompletedTask;
        }

        var doc = _docs.FirstOrDefault(d => d.Slug == Slug);

        if (doc is not null)
        {
            _doc.Title = doc.Title;
            _doc.Slug = doc.Slug;
            _doc.Category = doc.Category;
            _doc.Icon = doc.Icon;
            _doc.Content = doc.Content;
            _originalSlug = Slug;

            RenderMarkdown();
        }
        else
        {
            _htmlContent = "<div class='flex flex-col items-center justify-center h-64 text-center'><h2 class='text-2xl font-bold text-white! mb-2'>Page not found</h2><p class='text-lithium-400'>The documentation page you are looking for does not exist.</p></div>";
            _headings = [];
        }

        return Task.CompletedTask;
    }

    private void RenderMarkdown()
    {
        var pipeline = new MarkdownPipelineBuilder()
            .UseAdvancedExtensions()
            .UseAbbreviations()
            .UseAutoIdentifiers()
            .UseCitations()
            .UseCustomContainers()
            .UseDefinitionLists()
            .UseEmphasisExtras()
            .UseFigures()
            .UseFooters()
            .UseFootnotes()
            .UseGridTables()
            .UseMathematics()
            .UseMediaLinks()
            .UsePipeTables()
            .UseListExtras()
            .UseTaskLists()
            .UseDiagrams()
            .UseAutoLinks()
            .UseEmojiAndSmiley()
            .UseAlertBlocks()
            .UseGenericAttributes()
            .Build();

        var document = Markdown.Parse(_doc.Content, pipeline);

        _headings = document.Descendants<HeadingBlock>()
            .Select(h => new Heading
            {
                Text = h.Inline?.FirstChild?.ToString() ?? "Untitled",
                Slug = GenerateSlug(h.Inline?.FirstChild?.ToString() ?? ""),
                Level = h.Level
            })
            .ToList();

        _htmlContent = document.ToHtml(pipeline);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await JsRuntime.InvokeVoidAsync("lithiumDocs.init", DotNetObjectReference.Create(this));

        await JsRuntime.InvokeVoidAsync("lithiumDocs.initScrollSpy");
    }

    public void Dispose()
    {
        JsRuntime.InvokeVoidAsync("lithiumDocs.dispose");
    }

    private void ToggleEditMode()
    {
        if (!_isEditMode)
        {
            _originalDoc = new DocModel
            {
                Title = _doc.Title,
                Slug = _doc.Slug,
                Category = _doc.Category,
                Icon = _doc.Icon,
                Content = _doc.Content
            };
        }

        _isEditMode = !_isEditMode;
    }

    private void CancelEdit()
    {
        _doc.Title = _originalDoc.Title;
        _doc.Slug = _originalDoc.Slug;
        _doc.Category = _originalDoc.Category;
        _doc.Icon = _originalDoc.Icon;
        _doc.Content = _originalDoc.Content;

        RenderMarkdown();

        _isEditMode = false;
    }

    private Task OnMarkdownValueChanged(string value)
    {
        _doc.Content = value;
        RenderMarkdown();
        return Task.CompletedTask;
    }

    private async Task SaveChanges()
    {
        var newFilePath = Path.Combine(_docsPath, $"{_doc.Slug}.md");

        if (_originalSlug != _doc.Slug)
        {
            if (File.Exists(newFilePath))
            {
                await JsRuntime.InvokeVoidAsync("alert", $"A document with the slug '{_doc.Slug}' already exists. Please choose a unique slug.");
                return;
            }
        }

        if (_originalSlug != _doc.Slug)
        {
            var originalFilePath = Path.Combine(_docsPath, $"{_originalSlug}.md");

            if (File.Exists(originalFilePath))
                File.Delete(originalFilePath);
        }

        var frontMatter = $@"---
title: ""{_doc.Title}""
icon: ""{_doc.Icon}""
category: ""{_doc.Category}""
---
";
        var fullContent = frontMatter + "\n" + _doc.Content;

        await File.WriteAllTextAsync(newFilePath, fullContent);

        _isEditMode = false;

        NavigationManager.NavigateTo($"/docs/{_doc.Slug}", true);
    }

    private static Dictionary<string, string> ParseYamlFrontMatter(string markdown)
    {
        var dict = new Dictionary<string, string>();

        var match = Regex.Match(markdown, @"^---\s*(.+?)\s*---", RegexOptions.Singleline);
        if (!match.Success) return dict;

        var yaml = match.Groups[1].Value;

        foreach (var line in yaml.Split('\n'))
        {
            var parts = line.Split(':', 2);

            if (parts.Length is 2)
                dict[parts[0].Trim()] = parts[1].Trim().Trim('"');
        }

        return dict;
    }

    private static string GenerateSlug(string text)
    {
        var slug = text.ToLowerInvariant();
        slug = Regex.Replace(slug, @"\s+", "-");
        slug = Regex.Replace(slug, @"[^a-z0-9-]", "");

        return slug;
    }

}
