@page "/docs"
@page "/docs/{Slug}"
@using System.Security.Claims
@using System.Text.RegularExpressions
@using Markdig
@using Markdig.Extensions.AutoIdentifiers
@using Markdig.Extensions.Alerts
@using Markdig.Extensions.Abbreviations
@using Markdig.Extensions.Citations
@using Markdig.Extensions.CustomContainers
@using Markdig.Extensions.DefinitionLists
@using Markdig.Extensions.EmphasisExtras
@using Markdig.Extensions.Figures
@using Markdig.Extensions.Footers
@using Markdig.Extensions.Footnotes
@using Markdig.Extensions.Mathematics
@using Markdig.Extensions.MediaLinks
@using Markdig.Extensions.ListExtras
@using Markdig.Extensions.TaskLists
@using Markdig.Extensions.Diagrams
@using Markdig.Extensions.AutoLinks
@using Markdig.Extensions.Emoji
@using Markdig.Extensions.GenericAttributes
@using Markdig.Syntax
@using Microsoft.AspNetCore.Components.Web
@using System.ComponentModel.DataAnnotations
@using PSC.Blazor.Components.MarkdownEditor
@inject NavigationManager NavigationManager
@inject IWebHostEnvironment Env
@inject IJSRuntime JsRuntime
@layout EmptyLayout
@rendermode InteractiveServer
@implements IDisposable

<SearchModal @bind-IsOpen="_isSearchModalOpen" AllDocs="_docs"/>

<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.css"
          integrity="sha384-Pu5+C18nP5dwykLJOhd2U4Xen7rjScHN/qusop27hdd2drI+lL5KvX7YntvT8yew" crossorigin="anonymous">

    <!-- The loading of KaTeX is deferred to speed up page rendering -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.js"
            integrity="sha384-2B8pfmZZ6JlVoScJm/5hQfNS2TI/6hPqDZInzzPc8oHpN5SgeNOf4LzREO6p5YtZ"
            crossorigin="anonymous"></script>

    <!-- To automatically render math in text elements, include the auto-render extension: -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/contrib/auto-render.min.js"
            integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"
            onload="renderMathInElement(document.body);"></script>
</head>

<head>
    <link href="prism.css" rel="stylesheet"/>
</head>
<body>
<script src="prism.js"></script>
</body>

<!-- Mobile Header -->
<div
    class="sticky top-0 z-10 flex items-center justify-between px-4 py-3 bg-lithium-0 border-b border-lithium-100 lg:hidden">
    <button @onclick="ToggleNav" type="button" class="text-white p-2 rounded-md hover:bg-lithium-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
        </svg>
    </button>
    <span class="text-white font-semibold truncate">@(_docs.FirstOrDefault(d => d.Slug == Slug)?.Title)</span>
    <button @onclick="ToggleToc" type="button" class="text-white p-2 rounded-md hover:bg-lithium-50 xl:hidden">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
        </svg>
    </button>
</div>

<div class="relative lg:flex">
    <!-- Backdrop -->
    @if (_isNavOpen || _isTocOpen)
    {
        <div class="fixed inset-0 bg-black/30 z-30 lg:hidden" @onclick="CloseSidebars"></div>
    }

    <!-- Navbar -->
    <div
        class="@(_isNavOpen ? "translate-x-0" : "-translate-x-full") lg:translate-x-0 fixed top-0 left-0 z-40 lg:sticky w-72 shrink-0 h-screen overflow-y-auto bg-lithium-0 border-r border-lithium-100 transition-transform duration-300 ease-in-out">
        <div class="p-4">
            <div class="flex text-white my-2">
                <span>Lithium</span>
            </div>

            <div class="relative my-4">
                <button @onclick="OpenSearchModal"
                        class="w-full bg-lithium-50 border border-lithium-100 rounded-md px-3 py-2 text-left text-lithium-500 text-sm flex items-center justify-between">
                    <span>Search...</span>
                    <span class="text-xs border border-lithium-200 rounded-md px-1.5 py-0.5">Ctrl+K</span>
                </button>
            </div>
            <nav>
                @foreach (var group in _docs.GroupBy(x => x.Category, StringComparer.InvariantCultureIgnoreCase))
                {
                    <div class="flex flex-col px-3 py-2 gap-2">
                        <span class="text-sm text-white">@group.Key</span>
                        <div class="flex flex-col">
                            @foreach (var doc in group)
                            {
                                <NavLink href="@("/docs/" + doc.Slug)" @onclick="CloseSidebars"
                                         class="cursor-pointer px-3 py-2 rounded-md hover:bg-lithium-50 aria-[current=page]:bg-lithium-100 flex items-center gap-2 text-sm text-lithium-500! hover:text-white! aria-[current=page]:text-white!">
                                    <span>@doc.Icon</span>
                                    <span>@doc.Title</span>
                                </NavLink>
                            }
                        </div>
                    </div>
                }
            </nav>
        </div>
    </div>

    <!-- Contenu -->
    <main class="flex-1 min-w-0" id="docs-content">
        <div class="w-full px-4 sm:px-8 lg:px-16 xl:px-24 py-16 text-white">
            @if (_isEditMode)
            {
                <EditForm Model="@_doc" OnValidSubmit="SaveChanges"
                          class="space-y-8 bg-lithium-0/50 border border-lithium-100 rounded-lg shadow-lg p-8">
                    <DataAnnotationsValidator/>

                    <div class="space-y-2">
                        <h2 class="text-xl font-semibold">Metadata</h2>
                        <p class="text-sm text-lithium-400">Basic information about the document.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-lithium-300">Title</label>
                            <InputText @bind-Value="_doc.Title"
                                       class="mt-1 block w-full bg-lithium-50 border-lithium-100 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"/>
                            <ValidationMessage For="@(() => _doc.Title)" class="mt-1 text-sm text-red-400"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-lithium-300">Slug</label>
                            <InputText @bind-Value="_doc.Slug"
                                       class="mt-1 block w-full bg-lithium-50 border-lithium-100 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"/>
                            <ValidationMessage For="@(() => _doc.Slug)" class="mt-1 text-sm text-red-400"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-lithium-300">Category</label>
                            <InputText @bind-Value="_doc.Category"
                                       class="mt-1 block w-full bg-lithium-50 border-lithium-100 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"/>
                            <ValidationMessage For="@(() => _doc.Category)" class="mt-1 text-sm text-red-400"/>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-lithium-300">Icon (Emoji)</label>
                            <InputText @bind-Value="_doc.Icon"
                                       class="mt-1 block w-full bg-lithium-50 border-lithium-100 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"/>
                        </div>
                    </div>

                    <div class="border-t border-lithium-100"></div>

                    <MarkdownEditor Value="@_doc.Content" ValueChanged="OnMarkdownValueChanged"/>

                    <div class="flex justify-end space-x-4">
                        <button type="button" @onclick="CancelEdit"
                                class="inline-flex items-center gap-2 bg-lithium-100/60 hover:bg-lithium-100/80 text-white font-semibold py-2 px-4 border border-lithium-200 rounded-lg shadow-sm transition-colors cursor-pointer">
                            Cancel
                        </button>
                        <button type="submit"
                                class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 border border-indigo-500 rounded-lg shadow-sm transition-colors cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                 fill="currentColor">
                                <path
                                    d="M7.5 2.5a.5.5 0 00-1 0v1.562A2.5 2.5 0 004.063 6.5H2.5a.5.5 0 000 1h1.563A2.5 2.5 0 006.5 9.937V11.5a.5.5 0 001 0V9.937a2.5 2.5 0 002.437-2.437H11.5a.5.5 0 000-1H9.937A2.5 2.5 0 007.5 4.062V2.5zM6.5 5A1.5 1.5 0 115 6.5 1.5 1.5 0 016.5 5zM2.5 12a.5.5 0 000 1h1.063a2.5 2.5 0 004.874 0H17.5a.5.5 0 000-1H8.437a2.5 2.5 0 00-4.874 0H2.5z"/>
                            </svg>
                            Save Changes
                        </button>
                    </div>
                </EditForm>
            }
            else
            {
                <div class="prose">
                    @((MarkupString)_htmlContent)
                </div>
            }
        </div>
    </main>

    <!-- Table of Contents -->
    <div
        class="@(_isTocOpen ? "translate-x-0" : "translate-x-full") xl:translate-x-0 fixed top-0 right-0 z-40 xl:sticky w-72 shrink-0 h-screen overflow-y-auto bg-lithium-0 border-l border-lithium-100 transition-transform duration-300 ease-in-out">
        <div class="p-4">
            <div class="flex items-center justify-between xl:block">
                <h3 class="text-white text-sm font-semibold mb-4">On this page</h3>
                <button @onclick="ToggleToc" type="button"
                        class="text-white p-2 rounded-md hover:bg-lithium-50 xl:hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                         xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <ul class="space-y-2 border-l border-lithium-100">
                @foreach (var heading in _headings)
                {
                    var slugUri = $"/docs/{Slug}/#{heading.Slug}";
                    var padding = 1 + Math.Max(0, heading.Level - 1);
                    var style = $"padding-left: {padding}rem;";

                    <li>
                        <a href="@slugUri" @onclick="CloseSidebars"
                           class="toc-link -ml-px block border-l-2 border-transparent text-sm text-lithium-500! transition-colors duration-200 hover:border-white hover:text-white!"
                           style="@style">
                            @heading.Text
                        </a>
                    </li>
                }
            </ul>
            <AuthorizeView Policy="CanManageDocs">
                <Authorized>
                    <div class="mt-8">
                        <button @onclick="ToggleEditMode"
                                class="w-full text-center cursor-pointer px-3 py-2 rounded-md hover:bg-lithium-50 flex items-center gap-2 text-sm text-lithium-500! hover:text-white!">
                            <span>‚úèÔ∏è</span>
                            <span>Edit Page</span>
                        </button>
                    </div>
                </Authorized>
            </AuthorizeView>
        </div>
    </div>
</div>

<style>
    * {
        scroll-behavior: smooth;
    }

    .prose pre {
        position: relative;
    }
</style>

<script>
    window.lithiumDocs = {
        dotNetHelper: null,
        init: function (dotNetHelper) {
            this.dotNetHelper = dotNetHelper;
            document.addEventListener('keydown', this.handleKeyDown.bind(this));
        },
        handleKeyDown: function (e) {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                this.dotNetHelper.invokeMethodAsync('OpenSearchModal');
            }
        },
        dispose: function () {
            document.removeEventListener('keydown', this.handleKeyDown.bind(this));
        },
        scrollHandler: null,
        initScrollSpy: function () {
            const scrollContainer = document.getElementById('docs-content');
            if (!scrollContainer) return;

            const headings = Array.from(scrollContainer.querySelectorAll('.prose h1, .prose h2, .prose h3'));
            const tocLinks = document.querySelectorAll('.toc-link');

            if (headings.length === 0) return;

            const onScroll = () => {
                let activeId = null;
                const cutoff = 150; // px from top

                for (let i = 0; i < headings.length; i++) {
                    const heading = headings[i];
                    const rect = heading.getBoundingClientRect();

                    if (rect.top <= cutoff) {
                        activeId = heading.id;
                    } else {
                        if (!activeId && i === 0) activeId = heading.id;
                        break;
                    }
                }

                if (!activeId && headings.length > 0) activeId = headings[0].id;

                tocLinks.forEach(link => {
                    if (link.getAttribute('href').endsWith('#' + activeId)) {
                        link.classList.remove('border-transparent', 'text-lithium-500!');
                        link.classList.add('border-white', 'text-white!');
                    } else {
                        link.classList.add('border-transparent', 'text-lithium-500!');
                        link.classList.remove('border-white', 'text-white!');
                    }
                });
            };

            if (this.scrollHandler) {
                scrollContainer.removeEventListener('scroll', this.scrollHandler);
            }
            this.scrollHandler = onScroll;
            scrollContainer.addEventListener('scroll', onScroll);

            // Initial check
            onScroll();
        },
        renderMarkdownFeatures: function () {
            // Render KaTeX
            if (window.renderMathInElement) {
                renderMathInElement(document.body);
            }

            // Render Mermaid
            if (window.mermaid) {
                mermaid.initialize({startOnLoad: false, theme: 'dark'});
                mermaid.run({
                    nodes: document.querySelectorAll('.mermaid')
                });
            }
        }
    };
</script>

@code {

    private class Heading
    {
        public string Text { get; init; } = null!;
        public string Slug { get; init; } = null!;
        public int Level { get; init; }
    }

    private readonly List<DocModel> _docs = [];
    private string _htmlContent = null!;
    private List<Heading> _headings = [];
    private string? _currentSlug;
    private bool _isNavOpen = false;
    private bool _isTocOpen = false;
    private bool _isSearchModalOpen = false;
    private bool _isEditMode = false;
    private readonly DocModel _doc = new();
    private string _docsPath = null!;
    private string _originalSlug = null!;

    [Parameter] public string? Slug { get; set; }

    [JSInvokable]
    public void OpenSearchModal()
    {
        _isSearchModalOpen = true;
        StateHasChanged();
    }

    private void ToggleNav()
    {
        _isNavOpen = !_isNavOpen;
        if (_isNavOpen) _isTocOpen = false;
    }

    private void ToggleToc()
    {
        _isTocOpen = !_isTocOpen;
        if (_isTocOpen) _isNavOpen = false;
    }

    private void CloseSidebars()
    {
        _isNavOpen = false;
        _isTocOpen = false;
    }

    protected override void OnInitialized()
    {
        _docsPath = Path.Combine(Env.WebRootPath, "docs");
        var files = Directory.GetFiles(_docsPath, "*.md", SearchOption.AllDirectories);

        foreach (var file in files)
        {
            var markdown = File.ReadAllText(file);
            var meta = ParseYamlFrontMatter(markdown);
            var slug = Path.GetFileNameWithoutExtension(file);

            _docs.Add(new DocModel
            {
                Slug = slug,
                Title = meta.GetValueOrDefault("title", slug),
                Icon = meta.GetValueOrDefault("icon", "üìÑ"),
                Category = meta.GetValueOrDefault("category", "General"),
                Content = Regex.Replace(markdown, @"^---\s*(.+?)\s*---\s*", "", RegexOptions.Singleline).Trim()
            });
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Slug == _currentSlug) return;
        _currentSlug = Slug;

        if (string.IsNullOrEmpty(Slug))
        {
            var firstDoc = _docs.FirstOrDefault();

            if (firstDoc is not null)
                NavigationManager.NavigateTo($"/docs/{firstDoc.Slug}");

            return;
        }

        var doc = _docs.FirstOrDefault(d => d.Slug == Slug);

        if (doc is not null)
        {
            _doc.Title = doc.Title;
            _doc.Slug = doc.Slug;
            _doc.Category = doc.Category;
            _doc.Icon = doc.Icon;
            _doc.Content = doc.Content;

            _originalSlug = Slug;

            var pipeline = new MarkdownPipelineBuilder()
                .UseAdvancedExtensions()
                .UseAbbreviations()
                .UseAutoIdentifiers()
                .UseCitations()
                .UseCustomContainers()
                .UseDefinitionLists()
                .UseEmphasisExtras()
                .UseFigures()
                .UseFooters()
                .UseFootnotes()
                .UseGridTables()
                .UseMathematics()
                .UseMediaLinks()
                .UsePipeTables()
                .UseListExtras()
                .UseTaskLists()
                .UseDiagrams()
                .UseAutoLinks()
                .UseEmojiAndSmiley()
                .UseAlertBlocks()
                .UseGenericAttributes()
                .Build();

            var document = Markdown.Parse(doc.Content, pipeline);

            _headings = document.Descendants<HeadingBlock>()
                .Select(h => new Heading
                {
                    Text = h.Inline.FirstChild.ToString(),
                    Slug = GenerateSlug(h.Inline.FirstChild.ToString() ?? ""),
                    Level = h.Level
                })
                .ToList();

            _htmlContent = document.ToHtml(pipeline);
        }
        else
        {
            _htmlContent = "<p>Page not found.</p>";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JsRuntime.InvokeVoidAsync("lithiumDocs.init", DotNetObjectReference.Create(this));
        }

        await JsRuntime.InvokeVoidAsync("lithiumDocs.initScrollSpy");
        await JsRuntime.InvokeVoidAsync("lithiumDocs.renderMarkdownFeatures");
    }

    public void Dispose()
    {
        JsRuntime.InvokeVoidAsync("lithiumDocs.dispose");
    }

    private void ToggleEditMode()
    {
        _isEditMode = !_isEditMode;
    }

    private void CancelEdit()
    {
        _isEditMode = false;
    }

    private Task OnMarkdownValueChanged(string value)
    {
        _doc.Content = value;
        return Task.CompletedTask;
    }

    private async Task SaveChanges()
    {
        var newFilePath = Path.Combine(_docsPath, $"{_doc.Slug}.md");

        if (_originalSlug != _doc.Slug)
        {
            if (File.Exists(newFilePath))
            {
                await JsRuntime.InvokeVoidAsync("alert", $"A document with the slug '{_doc.Slug}' already exists. Please choose a unique slug.");
                return;
            }
        }

        if (_originalSlug != _doc.Slug)
        {
            var originalFilePath = Path.Combine(_docsPath, $"{_originalSlug}.md");

            if (File.Exists(originalFilePath))
                File.Delete(originalFilePath);
        }

        var frontMatter = $@"---
                            title: ""{_doc.Title}""
                            icon: ""{_doc.Icon}""
                            category: ""{_doc.Category}""
                            ---
                            ";
        var fullContent = frontMatter + "\n" + _doc.Content;

        await File.WriteAllTextAsync(newFilePath, fullContent);

        _isEditMode = false;

        NavigationManager.NavigateTo($"/docs/{_doc.Slug}", true);
    }

    private static Dictionary<string, string> ParseYamlFrontMatter(string markdown)
    {
        var dict = new Dictionary<string, string>();

        var match = Regex.Match(markdown, @"^---\s*(.+?)\s*---", RegexOptions.Singleline);
        if (!match.Success) return dict;

        var yaml = match.Groups[1].Value;

        foreach (var line in yaml.Split('\n'))
        {
            var parts = line.Split(':', 2);

            if (parts.Length is 2)
                dict[parts[0].Trim()] = parts[1].Trim().Trim('"');
        }

        return dict;
    }

    private static string GenerateSlug(string text)
    {
        var slug = text.ToLowerInvariant();
        slug = Regex.Replace(slug, @"\s+", "-");
        slug = Regex.Replace(slug, @"[^a-z0-9-]", "");

        return slug;
    }

}
